<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGV - FluxControl Dashboard</title>
    <link rel="icon" href="./media/MGV-art.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <style>
        html {
            width: 100%;
            overflow-x: hidden;
        }
        /* Notifica√ß√µes in-app: garantir topo e anima√ß√£o */
        #notifications-area { pointer-events: auto; position: fixed !important; top: 1rem !important; right: 1rem !important; z-index: 2147483647 !important; }
        .notif-card { border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.25); overflow: hidden; }
        .notif-enter { transform: translateY(-10px) translateX(10px) scale(0.98); opacity: 0; }
        .notif-enter-active { transform: translateY(0) translateX(0) scale(1); opacity: 1; transition: transform 400ms cubic-bezier(.2,.9,.2,1), opacity 400ms; }
        .notif-exit { opacity: 1; }
        .notif-exit-active { opacity: 0; transform: translateY(-8px); transition: transform 260ms ease-in, opacity 260ms ease-in; }

        
        
        * {
            box-sizing: border-box;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 25%, #f1f5f9 50%, #e2e8f0 75%, #cbd5e1 100%) !important;
            min-height: 100vh;
            transition: background 0.3s ease;
        }
        
        /* Tema Escuro */
        body.dark-mode.gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%) !important;
        }
        
        /* Cor padr√£o do texto (permite que classes de utilit√°rio sobrescrevam cores espec√≠ficas) */
        body {
            color: #000000;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            transition: color 0.3s ease;
        }
        
        body.dark-mode {
            color: #e2e8f0;
        }
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        body.dark-mode .glass {
            background: rgba(30, 41, 59, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        .pulse-shadow {
            animation: pulseShadow 2s infinite;
        }
        @keyframes pulseShadow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.1); }
            70% { box-shadow: 0 0 0 10px rgba(0, 0, 0, 0); }
        }
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        .sparkline {
            fill: none;
            stroke-width: 2;
            vector-effect: non-scaling-stroke;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        /* Responsividade Mobile */
        @media (max-width: 768px) {
            .container {
                padding: 1rem !important;
            }
            
            h1 {
                font-size: 2rem !important;
                line-height: 1.2 !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
            }
            
            h3 {
                font-size: 1rem !important;
            }
            
            p {
                font-size: 0.875rem !important;
            }
        }
        
        @media (max-width: 640px) {
            * {
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .container {
                padding: 1rem !important;
                width: 100% !important;
                overflow-x: hidden !important;
            }
            
            h1 {
                font-size: 1.75rem !important;
                margin-bottom: 1rem !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
            }
            
            .chart-container {
                height: 250px !important;
            }
            
            .glass {
                padding: 1rem !important;
            }
            
            button {
                font-size: 0.875rem !important;
                padding: 0.75rem 1rem !important;
            }
            
            input[type="text"],
            input[type="number"],
            input[type="date"],
            select {
                padding: 0.875rem !important;
                font-size: 1rem !important;
                border-radius: 0.75rem !important;
            }
            
            i[data-lucide] {
                width: 1.25rem !important;
                height: 1.25rem !important;
            }
        }
        
        @media (max-width: 480px) {
            * {
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .container {
                padding: 1rem !important;
                width: 100% !important;
                overflow-x: hidden !important;
            }
            
            h1 {
                font-size: 1.5rem !important;
                margin-bottom: 1rem !important;
                line-height: 1.3 !important;
            }
            
            h2 {
                font-size: 1.25rem !important;
            }
            
            h3 {
                font-size: 1rem !important;
            }
            
            p, span, label {
                font-size: 0.875rem !important;
            }
            
            .chart-container {
                height: 220px !important;
            }
            
            .glass {
                padding: 1rem !important;
                border-radius: 0.75rem !important;
            }
            
            button {
                padding: 0.75rem 1rem !important;
                font-size: 0.875rem !important;
                min-height: 44px !important;
            }
            
            input[type="text"],
            input[type="number"],
            input[type="date"],
            select {
                padding: 0.75rem !important;
                font-size: 1rem !important;
                border-radius: 0.75rem !important;
                min-height: 44px !important;
            }
            
            i[data-lucide] {
                width: 1.25rem !important;
                height: 1.25rem !important;
            }
            
            .grid {
                gap: 0.75rem !important;
            }
            
            .gap-2 {
                gap: 0.5rem !important;
            }
            
            .gap-3 {
                gap: 0.75rem !important;
            }
            
            .gap-4 {
                gap: 1rem !important;
            }
        }

        /* Export menu visual */
        .export-menu {
            position: absolute;
            min-width: 160px;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
            background: white;
            z-index: 2147483647;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        
        body.dark-mode .export-menu {
            background: #1e293b;
            box-shadow: 0 12px 30px rgba(0,0,0,0.5);
        }
        
        .export-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 160ms, transform 120ms, color 160ms;
            user-select: none;
        }
        
        body.dark-mode .export-option {
            color: #e2e8f0;
        }
        
        .export-option:hover { 
            transform: translateY(-2px);
        }
        
        body.dark-mode .export-option:hover {
            background-color: rgba(148, 163, 184, 0.2);
        }
        
        /* Textos no modo escuro */
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4,
        body.dark-mode h5,
        body.dark-mode h6 {
            color: #f1f5f9;
        }
        
        body.dark-mode p,
        body.dark-mode span,
        body.dark-mode label {
            color: #cbd5e1;
        }
        
        /* Inputs e selects em dark mode */
        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode input[type="date"],
        body.dark-mode input[type="password"],
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #334155;
            color: #e2e8f0;
            border-color: #475569;
        }
        
        body.dark-mode input[type="text"]::placeholder,
        body.dark-mode input[type="number"]::placeholder,
        body.dark-mode textarea::placeholder {
            color: #94a3b8;
        }
        
        /* Bot√µes em dark mode */
        body.dark-mode button {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Modais em dark mode */
        body.dark-mode #modal,
        body.dark-mode #name-modal,
        body.dark-mode #recorrente-modal {
            background-color: rgba(15, 23, 42, 0.9);
        }
        
        /* Border em dark mode */
        body.dark-mode .border-gray-300,
        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode input[type="date"],
        body.dark-mode select {
            border-color: #475569;
        }
        
        /* Cards/Glass em tabelas */
        body.dark-mode .bg-white {
            background-color: #1e293b;
            color: #e2e8f0;
        }
        
        /* Textos espec√≠ficos */
        body.dark-mode .text-gray-600 {
            color: #cbd5e1;
        }
        
        body.dark-mode .text-gray-500 {
            color: #94a3b8;
        }
        
        body.dark-mode .text-gray-700 {
            color: #e2e8f0;
        }
        
        body.dark-mode .text-gray-800 {
            color: #f1f5f9;
        }
        
        /* Backgrounds alterados */
        body.dark-mode .bg-gray-100,
        body.dark-mode .bg-gray-200,
        body.dark-mode .bg-gray-50 {
            background-color: #334155;
            color: #e2e8f0;
        }
        
        body.dark-mode .bg-green-50 {
            background-color: #0c3a20;
        }
        
        body.dark-mode .bg-red-50 {
            background-color: #3a0c0c;
        }
        
        /* Borders no dark mode */
        body.dark-mode .border-gray-200,
        body.dark-mode .border-gray-300 {
            border-color: #475569;
        }
        .export-option .dot { width:12px;height:12px;border-radius:3px;flex-shrink:0 }
        .export-csv:hover { background: rgba(59,130,246,0.06); }
        .export-csv .dot { background: #3b82f6 }
        .export-xml:hover { background: rgba(16,185,129,0.06); }
        .export-xml .dot { background: #10b981 }
        .export-json:hover { background: rgba(156,163,175,0.06); }
        .export-json .dot { background: #9ca3af }
    </style>
</head>
    <body class="gradient-bg min-h-screen">
        <!-- Notifica√ß√µes in-app (fora de qualquer stacking context) -->
        <div id="notifications-area" style="position:fixed;top:1rem;right:1rem;z-index:2147483647;pointer-events:auto"></div>
    <div class="container mx-auto w-full p-4 sm:p-6 md:p-8 relative" style="max-width: 100%; overflow-x: hidden; box-sizing: border-box;">
        <!-- Controles neutros (canto superior) - Responsivo -->
        <div class="flex flex-row gap-2 sm:gap-3 z-50 mb-4 sm:mb-6 justify-center sm:justify-end flex-wrap">
            <button onclick="renameUsername()" class="px-2 sm:px-3 py-1 sm:py-2 border border-gray-300 rounded-lg text-xs sm:text-sm hover:bg-gray-100 transition-colors whitespace-nowrap">Renomear</button>
            <button onclick="deleteAllData()" class="px-2 sm:px-3 py-1 sm:py-2 border border-gray-300 rounded-lg text-xs sm:text-sm hover:bg-gray-100 transition-colors whitespace-nowrap">Excluir dados</button>
        </div>
        <!-- Header -->
        <div class="text-center mb-6 sm:mb-8" data-aos="fade-down">
            <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-gray-800 mb-3 floating" style="line-height: 1.2;">Bem-Vindo ao seu Dashboard Financeiro.</h1>
            <p class="text-gray-600 text-sm sm:text-base md:text-lg px-2">Bem-Vindo ao seu Dashboard Financeiro com an√°lise completa de suas finan√ßas</p>
            <div class="mt-2 sm:mt-4 flex justify-center px-2">
                <div class="pulse-shadow bg-gray-200 bg-opacity-50 rounded-full px-3 sm:px-4 py-1 sm:py-2">
                    <span class="text-gray-700 text-xs font-medium" id="ultimo-update">√öltima atualiza√ß√£o: agora</span>
                </div>
            </div>
        </div>

        <!-- M√©tricas R√°pidas -->
        <div class="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4 md:grid-cols-4 mb-6 sm:mb-8">
            <div class="glass rounded-lg sm:rounded-2xl p-3 sm:p-4 text-center card-hover" data-aos="zoom-in" data-aos-delay="100">
                <div class="text-xl sm:text-2xl font-bold text-gray-800" id="meta-economia">20%</div>
                <div class="text-gray-600 text-xs sm:text-sm">Meta Economia</div>
                <div class="mt-2">
                    <svg class="progress-ring w-12 h-12 mx-auto">
                        <circle class="progress-ring-circle" stroke="rgba(255,255,255,0.3)" stroke-width="3" fill="transparent" r="18" cx="24" cy="24"/>
                        <circle class="progress-ring-circle" stroke="#22c55e" stroke-width="3" fill="transparent" r="18" cx="24" cy="24" id="meta-progress"/>
                    </svg>
                </div>
            </div>
            <div class="glass rounded-lg sm:rounded-2xl p-3 sm:p-4 text-center card-hover" data-aos="zoom-in" data-aos-delay="200">
                <div class="text-xl sm:text-2xl font-bold text-gray-800" id="dias-consecutivos">0</div>
                <div class="text-gray-600 text-xs sm:text-sm">Dias sem gastos</div>
                <div class="text-2xl sm:text-3xl mt-1">üî•</div>
            </div>
            <div class="glass rounded-lg sm:rounded-2xl p-3 sm:p-4 text-center card-hover" data-aos="zoom-in" data-aos-delay="300">
                <div class="text-xl sm:text-2xl font-bold text-gray-800" id="media-diaria">R$ 0</div>
                <div class="text-gray-600 text-xs sm:text-sm">M√©dia Di√°ria</div>
                <div class="text-2xl sm:text-3xl mt-1">üìä</div>
            </div>
            <div class="glass rounded-lg sm:rounded-2xl p-3 sm:p-4 text-center card-hover" data-aos="zoom-in" data-aos-delay="400">
                <div class="text-xl sm:text-2xl font-bold text-gray-800" id="projecao-mes">R$ 0</div>
                <div class="text-gray-600 text-xs sm:text-sm">Proje√ß√£o M√™s</div>
                <div class="text-2xl sm:text-3xl mt-1">üéØ</div>
            </div>
        </div>

        <!-- Cards Principais -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6 sm:mb-8">
            <!-- Saldo Total -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl card-hover" data-aos="fade-up" data-aos-delay="100">
            <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                    <div class="p-2 sm:p-3 bg-blue-500 bg-opacity-20 rounded-xl sm:rounded-2xl pulse-shadow">
                        <i data-lucide="wallet" class="w-4 sm:w-6 h-4 sm:h-6 text-blue-600"></i>
                    </div>
                    <div class="text-right overflow-hidden">
                        <svg class="w-12 sm:w-16 h-6 sm:h-8 sparkline" viewBox="0 0 100 30">
                            <polyline class="sparkline" stroke="#60a5fa" points="0,20 20,15 40,25 60,10 80,18 100,12" id="sparkline-saldo"/>
                        </svg>
                    </div>
                </div>
                <p class="text-gray-600 text-xs sm:text-sm mb-1">Saldo Total</p>
                <p class="text-2xl sm:text-3xl font-bold text-gray-800" id="saldo-total">R$ 0,00</p>
                <div class="mt-3 pt-3 border-t border-gray-300">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between gap-1">
                        <span class="text-gray-500 text-xs" id="taxa-economia">Taxa de economia: 0%</span>
                        <span class="text-xs text-green-600" id="variacao-saldo">+0%</span>
                    </div>
                </div>
            </div>

            <!-- Receitas -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl card-hover" data-aos="fade-up" data-aos-delay="200">
                <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                    <div class="p-2 sm:p-3 bg-green-500 bg-opacity-20 rounded-xl sm:rounded-2xl pulse-shadow">
                        <i data-lucide="trending-up" class="w-4 sm:w-6 h-4 sm:h-6 text-green-600"></i>
                    </div>
                    <span class="text-green-700 text-xs font-semibold bg-green-200 px-2 sm:px-3 py-1 rounded-full text-ellipsis overflow-hidden" id="contador-receitas">+0</span>
                </div>
                <p class="text-gray-600 text-xs sm:text-sm mb-1">Receitas</p>
                <p class="text-2xl sm:text-3xl font-bold text-green-600" id="total-receitas">R$ 0,00</p>
                <div class="mt-3 pt-3 border-t border-gray-300">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between gap-1">
                        <span class="text-gray-500 text-xs">Este m√™s</span>
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                            <span class="text-xs text-green-600">Ativo</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Despesas -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl card-hover" data-aos="fade-up" data-aos-delay="300">
                <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                    <div class="p-2 sm:p-3 bg-red-500 bg-opacity-20 rounded-xl sm:rounded-2xl pulse-shadow">
                        <i data-lucide="trending-down" class="w-4 sm:w-6 h-4 sm:h-6 text-red-600"></i>
                    </div>
                    <span class="text-red-700 text-xs font-semibold bg-red-200 px-2 sm:px-3 py-1 rounded-full text-ellipsis overflow-hidden" id="contador-despesas">0</span>
                </div>
                <p class="text-gray-600 text-xs sm:text-sm mb-1">Despesas</p>
                <p class="text-2xl sm:text-3xl font-bold text-red-600" id="total-despesas">R$ 0,00</p>
                <div class="mt-3 pt-3 border-t border-gray-300">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between gap-1">
                        <span class="text-gray-500 text-xs" id="percentual-despesas">0% da receita</span>
                        <span class="text-xs text-red-600" id="variacao-despesas">+0%</span>
                    </div>
                </div>
            </div>

            <!-- Maior Gasto -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl card-hover" data-aos="fade-up" data-aos-delay="400">
                <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                    <div class="p-2 sm:p-3 bg-orange-500 bg-opacity-20 rounded-xl sm:rounded-2xl pulse-shadow">
                        <i data-lucide="target" class="w-4 sm:w-6 h-4 sm:h-6 text-orange-600"></i>
                    </div>
                    <i data-lucide="credit-card" class="w-4 sm:w-5 h-4 sm:h-5 text-gray-500"></i>
                </div>
                <p class="text-gray-600 text-xs sm:text-sm mb-1">Maior Gasto</p>
                <p class="text-2xl sm:text-3xl font-bold text-orange-600" id="maior-gasto">R$ 0,00</p>
                <div class="mt-3 pt-3 border-t border-gray-300">
                    <p class="text-gray-500 text-xs" id="categoria-maior-gasto">Sem gastos</p>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de Gr√°ficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8">
            <!-- Gr√°fico de Pizza - Distribui√ß√£o de Gastos -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl card-hover" data-aos="fade-right">
                <div class="flex items-center gap-2 sm:gap-3 mb-4 sm:mb-6 flex-wrap">
                    <i data-lucide="pie-chart" class="w-5 sm:w-6 h-5 sm:h-6 text-gray-700"></i>
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">Distribui√ß√£o de Gastos</h3>
                    <div class="ml-auto">
                        <button class="text-gray-500 hover:text-gray-700 transition-colors" onclick="toggleChartView('pie')">
                            <i data-lucide="maximize-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <!-- Gr√°fico de Linha - Evolu√ß√£o Temporal -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl card-hover" data-aos="fade-left">
                <div class="flex items-center gap-2 sm:gap-3 mb-4 sm:mb-6 flex-wrap">
                    <i data-lucide="trending-up" class="w-5 sm:w-6 h-5 sm:h-6 text-gray-700"></i>
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">Evolu√ß√£o Temporal</h3>
                    <div class="ml-auto">
                        <button class="text-gray-500 hover:text-gray-700 transition-colors" onclick="toggleChartView('line')">
                            <i data-lucide="maximize-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos Adicionais -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8">
            <!-- Gr√°fico de Barras - Compara√ß√£o Mensal -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl card-hover" data-aos="fade-up" data-aos-delay="100">
                <div class="flex items-center gap-2 sm:gap-3 mb-4 sm:mb-6 flex-wrap">
                    <i data-lucide="bar-chart-3" class="w-5 sm:w-6 h-5 sm:h-6 text-gray-700"></i>
                    <h3 class="text-base sm:text-lg font-bold text-gray-800">Compara√ß√£o Mensal</h3>
                </div>
                <div class="chart-container h-48">
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <!-- Gr√°fico Radar - An√°lise de Categorias -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl card-hover" data-aos="fade-up" data-aos-delay="200">
                <div class="flex items-center gap-2 sm:gap-3 mb-4 sm:mb-6 flex-wrap">
                    <i data-lucide="activity" class="w-5 sm:w-6 h-5 sm:h-6 text-gray-700"></i>
                    <h3 class="text-base sm:text-lg font-bold text-gray-800">An√°lise por Categoria</h3>
                </div>
                <div class="chart-container h-48">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <!-- Metas e Progresso -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl card-hover" data-aos="fade-up" data-aos-delay="300">
                <div class="flex items-center gap-2 sm:gap-3 mb-4 sm:mb-6 flex-wrap">
                    <i data-lucide="target" class="w-5 sm:w-6 h-5 sm:h-6 text-gray-700"></i>
                    <h3 class="text-base sm:text-lg font-bold text-gray-800">Metas Financeiras</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-gray-700 text-xs sm:text-sm mb-2">
                            <span>Meta Economia</span>
                            <span id="meta-economia-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-300 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-green-400 to-green-600 h-full rounded-full transition-all duration-1000" style="width: 0%" id="progress-economia"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-gray-700 text-xs sm:text-sm mb-2">
                            <span>Controle de Gastos</span>
                            <span id="meta-gastos-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-300 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-full rounded-full transition-all duration-1000" style="width: 0%" id="progress-gastos"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-gray-700 text-xs sm:text-sm mb-2">
                            <span>Diversifica√ß√£o</span>
                            <span id="meta-diversificacao-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-300 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-purple-400 to-purple-600 h-full rounded-full transition-all duration-1000" style="width: 0%" id="progress-diversificacao"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gastos Mensais (movido para cima da √°rea de nova transa√ß√£o) -->
        <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl mb-6 sm:mb-8">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800">Gastos Mensais</h3>
                <div class="flex items-center gap-2">
                    <button onclick="openRecorrenteModal()" class="glass hover:bg-gray-200 hover:bg-opacity-60 text-gray-800 font-semibold px-3 sm:px-6 py-2 sm:py-4 rounded-full shadow-xl transition-all duration-300 flex items-center justify-center gap-2 sm:gap-3 hover:scale-105 text-xs sm:text-base">
                        <i data-lucide="plus" class="w-4 sm:w-5 h-4 sm:h-5"></i>
                        Adicionar
                    </button>
                </div>
            </div>
            <div id="recorrentes-list" class="space-y-3">
                <p class="text-gray-500 text-sm">Nenhum gasto mensal cadastrado</p>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="flex flex-col sm:flex-row justify-center gap-2 sm:gap-3 mb-6 sm:mb-8 px-0 sm:px-2" data-aos="zoom-in">
            <button onclick="abrirModal()" class="glass hover:bg-gray-200 hover:bg-opacity-60 text-gray-800 font-semibold px-3 sm:px-8 py-2 sm:py-4 rounded-full shadow-2xl transition-all duration-300 flex items-center justify-center gap-2 sm:gap-3 hover:scale-105 pulse-shadow text-xs sm:text-base">
                <i data-lucide="plus" class="w-4 sm:w-6 h-4 sm:h-6"></i>
                Nova Transa√ß√£o
            </button>
            <button id="export-btn" onclick="showExportMenu(event)" class="glass hover:bg-gray-100 hover:bg-opacity-60 text-gray-700 font-semibold px-3 sm:px-6 py-2 sm:py-4 rounded-full shadow-xl transition-all duration-300 flex items-center justify-center gap-2 sm:gap-3 hover:scale-105 text-xs sm:text-base">
                <i data-lucide="download" class="w-4 sm:w-5 h-4 sm:h-5"></i>
                Exportar
            </button>
            <button onclick="toggleDarkMode()" class="glass hover:bg-gray-100 hover:bg-opacity-60 text-gray-700 font-semibold px-3 sm:px-6 py-2 sm:py-4 rounded-full shadow-xl transition-all duration-300 flex items-center justify-center gap-2 sm:gap-3 hover:scale-105 text-xs sm:text-base">
                <i data-lucide="moon" class="w-5 sm:w-5 h-5 sm:h-5" id="theme-icon"></i>
                Tema
            </button>
        </div>

        <!-- Lista de Transa√ß√µes -->
        <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl" data-aos="fade-up">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6">Transa√ß√µes Recentes</h2>
            <div id="lista-transacoes" class="space-y-3">
                <div class="text-center py-8 sm:py-12 px-2">
                    <p class="text-gray-500 text-base sm:text-lg">Nenhuma transa√ß√£o registrada</p>
                    <p class="text-gray-400 text-xs sm:text-sm mt-2">Adicione sua primeira transa√ß√£o</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-3 sm:p-4 z-50 hidden overflow-y-auto">
        <div class="glass bg-white bg-opacity-95 rounded-2xl sm:rounded-3xl w-full shadow-2xl overflow-hidden flex flex-col my-auto" style="max-width: 28rem; max-height: 90vh;">
            <div class="flex justify-between items-start sm:items-center p-4 sm:p-6 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-lg sm:text-2xl font-bold text-gray-800 flex-1 pr-2">Nova Transa√ß√£o</h3>
                <button onclick="fecharModal()" class="p-2 hover:bg-gray-200 hover:bg-opacity-50 rounded-full transition-colors flex-shrink-0">
                    <i data-lucide="x" class="w-4 sm:w-6 h-4 sm:h-6 text-gray-600"></i>
                </button>
            </div>

            <div class="overflow-y-auto flex-1 p-4 sm:p-6">
                <div class="space-y-2 sm:space-y-4">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <div class="grid grid-cols-2 gap-2 sm:gap-3">
                            <button onclick="selecionarTipo('income')" id="btn-income" class="p-3 sm:p-4 rounded-lg sm:rounded-xl border-2 border-green-500 bg-green-50 transition-all flex items-center justify-center gap-2 text-sm">
                                <i data-lucide="trending-up" class="w-4 sm:w-5 h-4 sm:h-5 text-green-600"></i>
                                Receita
                            </button>
                            <button onclick="selecionarTipo('expense')" id="btn-expense" class="p-3 sm:p-4 rounded-lg sm:rounded-xl border-2 border-gray-300 hover:border-red-500 transition-all flex items-center justify-center gap-2 text-sm">
                                <i data-lucide="trending-down" class="w-4 sm:w-5 h-4 sm:h-5 text-red-600"></i>
                                Despesa
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm sm:text-sm font-medium text-gray-700 mb-2">Valor (R$)</label>
                        <input type="number" step="0.01" id="valor" class="w-full p-3 sm:p-3 border border-gray-300 rounded-xl text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0,00">
                    </div>

                    <div>
                        <label class="block text-sm sm:text-sm font-medium text-gray-700 mb-2">Categoria</label>
                        <select id="categoria" class="w-full p-3 sm:p-3 border border-gray-300 rounded-xl text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm sm:text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                        <input type="text" id="descricao" class="w-full p-3 sm:p-3 border border-gray-300 rounded-xl text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Opcional">
                    </div>

                    <div>
                        <label class="block text-sm sm:text-sm font-medium text-gray-700 mb-2">Data</label>
                        <input type="date" id="data" class="w-full p-3 sm:p-3 border border-gray-300 rounded-xl text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 p-4 sm:p-6 flex gap-3 flex-shrink-0">
                <button onclick="fecharModal()" class="flex-1 px-4 sm:px-6 py-3 text-base border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                    Cancelar
                </button>
                <button onclick="adicionarTransacao()" class="flex-1 px-4 sm:px-6 py-3 text-base bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors font-medium">
                    Adicionar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nome do Usu√°rio -->
    <div id="name-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-3 sm:p-4 z-50 hidden overflow-y-auto">
        <div class="glass bg-white bg-opacity-95 rounded-2xl sm:rounded-3xl w-full shadow-2xl overflow-hidden flex flex-col my-auto" style="max-width: 28rem; max-height: 90vh;">
            <div class="p-4 sm:p-6 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800">Como prefere ser chamado?</h3>
            </div>
            
            <div class="overflow-y-auto flex-1 p-4 sm:p-6">
                <input id="username-input" type="text" class="w-full p-3 border border-gray-300 rounded-xl text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Seu nome">
            </div>
            
            <div class="border-t border-gray-200 p-4 sm:p-6 flex gap-3 justify-end flex-shrink-0">
                <button onclick="skipName()" class="px-4 sm:px-6 py-3 text-base border rounded-xl hover:bg-gray-50 transition-colors font-medium">Pular</button>
                <button onclick="saveNameFromModal()" class="px-4 sm:px-6 py-3 text-base bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors font-medium">Salvar</button>
            </div>
        </div>
    </div>

        <!-- Modal Recorrente (Gasto Mensal) -->
        <div id="recorrente-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-3 sm:p-4 z-50 hidden overflow-y-auto">
            <div class="glass bg-white bg-opacity-95 rounded-2xl sm:rounded-3xl w-full shadow-2xl overflow-hidden flex flex-col my-auto" style="max-width: 28rem; max-height: 90vh;">
                <div class="p-4 sm:p-6 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">Novo Gasto Mensal</h3>
                </div>
                <div class="overflow-y-auto flex-1 p-4 sm:p-6">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                            <input id="rec-name" type="text" class="w-full p-3 border border-gray-300 rounded-xl text-base" placeholder="Ex: Netflix">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor (R$)</label>
                            <input id="rec-amount" type="number" step="0.01" class="w-full p-3 border border-gray-300 rounded-xl text-base" placeholder="0,00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                            <select id="rec-category" class="w-full p-3 border border-gray-300 rounded-xl text-base">
                                <option value="">Selecione</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dia do m√™s</label>
                            <input id="rec-day" type="number" min="1" max="28" class="w-32 p-2 border border-gray-300 rounded-xl text-base" placeholder="Dia">
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="rec-active" type="checkbox" checked>
                            <label class="text-sm">Ativo</label>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-200 p-4 sm:p-6 flex gap-3 justify-end flex-shrink-0">
                    <button onclick="closeRecorrenteModal()" class="px-4 py-2 border rounded-xl hover:bg-gray-50">Cancelar</button>
                    <button onclick="saveRecorrenteFromModal()" class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600">Salvar</button>
                </div>
            </div>
        </div>

        <script>
        // Inicializar √≠cones Lucide e AOS
        lucide.createIcons();
        AOS.init({
            duration: 800,
            easing: 'ease-out-cubic'
        });

        // Dados e gr√°ficos
        // `transacoes` ser√° carregado do IndexedDB na inicializa√ß√£o
        let transacoes = [];
        let tipoSelecionado = 'income';
        let charts = {};
        let db; // Dexie DB instance
        let recorrentes = []; // gastos mensais (faturas, assinaturas, contas)

        // Inicializa IndexedDB via Dexie e migra localStorage se necess√°rio
        async function initDBandMigrate() {
            if (typeof Dexie === 'undefined') {
                console.warn('Dexie n√£o carregado; usando localStorage como fallback');
                return;
            }

            db = new Dexie('financeiroDB');
            // vers√£o 1: transacoes, vers√£o 2: adiciona store `app` para configura√ß√µes (ex.: username)
            db.version(1).stores({ transacoes: 'id,date,type,category,amount' });
            db.version(2).stores({ transacoes: 'id,date,type,category,amount', app: 'key' });
            // vers√£o 3: adiciona store para gastos mensais (recorrentes)
            db.version(3).stores({ transacoes: 'id,date,type,category,amount', app: 'key', recorrentes: 'id,name,amount,category,day,active' });
            await db.open();

            // Se DB vazio mas houver dados em localStorage, migrar
            const count = await db.transacoes.count();
            const local = JSON.parse(localStorage.getItem('transacoes') || '[]');
            const migratedFlag = localStorage.getItem('transacoes_migrated');
            if (count === 0 && Array.isArray(local) && local.length > 0 && !migratedFlag) {
                try {
                    await db.transacoes.bulkPut(local);
                    // marca como migrado para n√£o sobrescrever no futuro
                    localStorage.setItem('transacoes_migrated', new Date().toISOString());
                } catch (e) {
                    console.error('Erro migrando para IndexedDB', e);
                }
            }
            // Se houver recorrentes em localStorage, migrar para IndexedDB na primeira abertura
            const localRec = JSON.parse(localStorage.getItem('recorrentes') || '[]');
            if (Array.isArray(localRec) && localRec.length > 0) {
                try {
                    await db.recorrentes.bulkPut(localRec);
                    localStorage.removeItem('recorrentes');
                } catch (e) {
                    console.warn('Erro migrando recorrentes para IndexedDB', e);
                }
            }
        }

        async function loadTransacoesFromDB() {
            if (db) {
                // ordenar por id decrescente para manter comportamento atual (unshift)
                const all = await db.transacoes.orderBy('id').reverse().toArray();
                transacoes = all || [];
            } else {
                transacoes = JSON.parse(localStorage.getItem('transacoes') || '[]');
            }
        }

        // Recorrentes (gastos mensais) helpers
        async function loadRecorrentesFromDB() {
            if (db) {
                const all = await db.recorrentes.orderBy('id').reverse().toArray();
                recorrentes = all || [];
            } else {
                recorrentes = JSON.parse(localStorage.getItem('recorrentes') || '[]');
            }
        }

        async function saveRecorrenteToDB(rec) {
            if (db) {
                await db.recorrentes.put(rec);
            } else {
                recorrentes.unshift(rec);
                localStorage.setItem('recorrentes', JSON.stringify(recorrentes));
            }
        }

        async function removeRecorrenteFromDB(id) {
            if (db) {
                await db.recorrentes.delete(id);
            } else {
                recorrentes = recorrentes.filter(r => r.id !== id);
                localStorage.setItem('recorrentes', JSON.stringify(recorrentes));
            }
        }

        function renderRecorrentes() {
            const container = document.getElementById('recorrentes-list');
            if (!container) return;
            if (!recorrentes || recorrentes.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">Nenhum gasto mensal cadastrado</p>`;
                return;
            }

            container.innerHTML = recorrentes.map(r => `
                <div class="flex items-center justify-between bg-white bg-opacity-30 p-3 rounded-xl">
                    <div>
                        <p class="font-semibold">${r.name}</p>
                        <p class="text-xs text-gray-600">${r.category} ‚Ä¢ dia ${r.day}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <p class="font-bold">R$ ${Number(r.amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                        <button onclick="handleRemoveRecorrente(${r.id})" class="p-2 rounded-lg hover:bg-white hover:bg-opacity-20">
                            <i data-lucide="trash-2" class="w-4 h-4 text-gray-700"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function handleRemoveRecorrente(id) {
            const ok = confirm('Remover gasto mensal?');
            if (!ok) return;
            removeRecorrenteFromDB(id).then(() => {
                recorrentes = recorrentes.filter(r => r.id !== id);
                renderRecorrentes();
                atualizarDashboard();
            }).catch(e => console.error(e));
        }

        function openRecorrenteModal() {
            // popular select de categorias com lista fixa de Gastos Mensais
            const sel = document.getElementById('rec-category');
            sel.innerHTML = '<option value="">Selecione</option>';
            categoriasRecorrentes.forEach(c => {
                const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o);
            });
            document.getElementById('rec-name').value = '';
            document.getElementById('rec-amount').value = '';
            document.getElementById('rec-day').value = '';
            document.getElementById('rec-active').checked = true;
            document.getElementById('recorrente-modal').classList.remove('hidden');
        }

        function closeRecorrenteModal() {
            document.getElementById('recorrente-modal').classList.add('hidden');
        }

        async function saveRecorrenteFromModal() {
            const name = document.getElementById('rec-name').value && document.getElementById('rec-name').value.trim();
            const amount = parseFloat(document.getElementById('rec-amount').value || 0);
            const category = document.getElementById('rec-category').value;
            const day = parseInt(document.getElementById('rec-day').value || '1', 10);
            const active = document.getElementById('rec-active').checked;

            if (!name || !amount || !category) {
                alert('Preencha nome, valor e categoria');
                return;
            }

            const rec = { id: Date.now(), name, amount: Number(amount), category, day: Math.max(1, Math.min(28, day)), active };
            await saveRecorrenteToDB(rec);
            // atualizar array em mem√≥ria
            recorrentes.unshift(rec);
            renderRecorrentes();
            atualizarDashboard();
            closeRecorrenteModal();
        }

        // Usuario (nome) helpers
        async function getSavedUsername() {
            if (!db) return localStorage.getItem('username') || null;
            try {
                const rec = await db.app.get('username');
                return rec ? rec.value : null;
            } catch (e) {
                console.error('Erro lendo username do DB', e);
                return null;
            }
        }

        async function saveUsername(name) {
            if (!db) {
                localStorage.setItem('username', name);
                return;
            }
            try {
                await db.app.put({ key: 'username', value: name });
            } catch (e) {
                console.error('Erro salvando username no DB', e);
            }
        }

        async function saveTransacaoToDB(transacao) {
            if (db) {
                await db.transacoes.put(transacao);
            } else {
                // fallback
                transacoes.unshift(transacao);
                localStorage.setItem('transacoes', JSON.stringify(transacoes));
            }
        }

        async function removeTransacaoFromDB(id) {
            if (db) {
                await db.transacoes.delete(id);
            } else {
                transacoes = transacoes.filter(t => t.id !== id);
                localStorage.setItem('transacoes', JSON.stringify(transacoes));
            }
        }

        // Configura√ß√µes dos gr√°ficos
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(75, 85, 99, 0.8)',
                        font: { family: 'system-ui' }
                    }
                }
            },
            scales: {
                y: {
                    grid: { color: 'rgba(75, 85, 99, 0.1)' },
                    ticks: { color: 'rgba(75, 85, 99, 0.8)' }
                },
                x: {
                    grid: { color: 'rgba(75, 85, 99, 0.1)' },
                    ticks: { color: 'rgba(75, 85, 99, 0.8)' }
                }
            }
        };

        // Categorias
        const categorias = {
            income: ['Sal√°rio', 'Freelance', 'Investimentos', 'Outros'],
            expense: ['Alimenta√ß√£o', 'Transporte', 'Moradia', 'Lazer', 'Sa√∫de', 'Educa√ß√£o', 'Compras', 'Contas', 'Outros']
        };
        // Categorias sugeridas especificamente para Gastos Mensais (recorrentes)
        const categoriasRecorrentes = [
            'Conta de √Ågua',
            'Conta de Energia',
            'Assinaturas',
            'Faturas',
            'Internet',
            'Telefone',
            'Aluguel',
            'Condom√≠nio',
            'Seguro'
        ];

        // Inicializar (agora ass√≠ncrono para suportar IndexedDB)
        document.addEventListener('DOMContentLoaded', async function() {
            // Carregar prefer√™ncia de tema
            loadDarkModePreference();
            
            document.getElementById('data').value = new Date().toISOString().split('T')[0];
            await initDBandMigrate();
            await loadTransacoesFromDB();
            await loadRecorrentesFromDB();
            // carregar/salvar nome do usu√°rio e exibir modal se necess√°rio
            const savedName = await getSavedUsername();
            if (savedName) {
                // atualizar sauda√ß√£o
                setGreeting(savedName);
            } else {
                // abrir modal de nome
                showNameModal();
            }

            atualizarCategorias();
            renderRecorrentes();
            atualizarDashboard();
            criarGraficos();
            atualizarUltimaAtualizacao();
            setInterval(atualizarUltimaAtualizacao, 60000); // Atualizar a cada minuto
            // recriar √≠cones para novos elementos (bot√£o adicionar)
            try { lucide.createIcons(); } catch(e){}
        });

        function atualizarUltimaAtualizacao() {
            const agora = new Date();
            const formato = agora.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('ultimo-update').textContent = `√öltima atualiza√ß√£o: ${formato}`;
        }

        // Atualiza o t√≠tulo com sauda√ß√£o curta dependendo do hor√°rio
        function setGreeting(name) {
            const h1 = document.querySelector('h1');
            if (!h1) return;
            const hora = new Date().getHours();
            let saudacao = 'Ol√°';
            if (hora >= 5 && hora < 12) {
                saudacao = 'Bom dia';
            } else if (hora >= 12 && hora < 18) {
                saudacao = 'Boa tarde';
            } else {
                saudacao = 'Boa noite';
            }
            // Sauda√ß√£o curta na linha principal, subt√≠tulo permanece abaixo
            h1.textContent = `${saudacao}, ${name}.`;
        }

        function criarGraficos() {
            criarGraficoPizza();
            criarGraficoLinha();
            criarGraficoBarras();
            criarGraficoRadar();
        }

        function criarGraficoPizza() {
            const ctx = document.getElementById('pieChart').getContext('2d');
            const categoriasDespesa = {};
            
            transacoes.filter(t => t.type === 'expense').forEach(t => {
                categoriasDespesa[t.category] = (categoriasDespesa[t.category] || 0) + t.amount;
            });

            // Incluir gastos mensais recorrentes na distribui√ß√£o de despesas
            (recorrentes || []).filter(r => r.active).forEach(r => {
                categoriasDespesa[r.category] = (categoriasDespesa[r.category] || 0) + Number(r.amount || 0);
            });

            const cores = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];

            if (charts.pie) charts.pie.destroy();
            
            charts.pie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                        labels: Object.keys(categoriasDespesa),
                        datasets: [{
                        data: Object.values(categoriasDespesa),
                        backgroundColor: cores.slice(0, Object.keys(categoriasDespesa).length),
                        borderColor: 'rgba(75, 85, 99, 0.8)',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartConfig,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(75, 85, 99, 0.8)',
                                padding: 20,
                                font: { size: 12 }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function criarGraficoLinha() {
            const ctx = document.getElementById('lineChart').getContext('2d');
            
            // Dados dos √∫ltimos 30 dias
            const dados = Array.from({length: 30}, (_, i) => {
                const data = new Date();
                data.setDate(data.getDate() - (29 - i));
                const dataStr = data.toISOString().split('T')[0];
                
                const receitas = transacoes
                    .filter(t => t.date === dataStr && t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const despesas = transacoes
                    .filter(t => t.date === dataStr && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                return {
                    data: data.getDate(),
                    receitas,
                    despesas,
                    saldo: receitas - despesas
                };
            });

            if (charts.line) charts.line.destroy();
            
            charts.line = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dados.map(d => d.data),
                    datasets: [
                        {
                            label: 'Receitas',
                            data: dados.map(d => d.receitas),
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Despesas',
                            data: dados.map(d => d.despesas),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: chartConfig
            });
        }

        function criarGraficoBarras() {
            const ctx = document.getElementById('barChart').getContext('2d');
            
            // Dados dos √∫ltimos 6 meses
            const meses = Array.from({length: 6}, (_, i) => {
                const data = new Date();
                data.setMonth(data.getMonth() - (5 - i));
                return {
                    nome: data.toLocaleDateString('pt-BR', { month: 'short' }),
                    mes: data.toISOString().substring(0, 7)
                };
            });

            const dadosMeses = meses.map(m => {
                const receitas = transacoes
                    .filter(t => t.date.startsWith(m.mes) && t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const despesas = transacoes
                    .filter(t => t.date.startsWith(m.mes) && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                return { nome: m.nome, receitas, despesas };
            });

            if (charts.bar) charts.bar.destroy();
            
            charts.bar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dadosMeses.map(d => d.nome),
                    datasets: [
                        {
                            label: 'Receitas',
                            data: dadosMeses.map(d => d.receitas),
                            backgroundColor: 'rgba(34, 197, 94, 0.8)'
                        },
                        {
                            label: 'Despesas',
                            data: dadosMeses.map(d => d.despesas),
                            backgroundColor: 'rgba(239, 68, 68, 0.8)'
                        }
                    ]
                },
                options: chartConfig
            });
        }

        function criarGraficoRadar() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            const categorias = ['Alimenta√ß√£o', 'Transporte', 'Moradia', 'Lazer', 'Sa√∫de'];
            const dados = categorias.map(cat => {
                return transacoes
                    .filter(t => t.category === cat && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
            });

            if (charts.radar) charts.radar.destroy();
            
            charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: categorias,
                    datasets: [{
                        label: 'Gastos por Categoria',
                        data: dados,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(75, 85, 99, 0.8)'
                            }
                        }
                    },
                    scales: {
                        r: {
                            grid: { color: 'rgba(75, 85, 99, 0.1)' },
                            ticks: { color: 'rgba(75, 85, 99, 0.8)' }
                        }
                    }
                }
            });
        }

        // Exportar dados em CSV, XML ou JSON (planilha).
        async function exportarDados(format = 'json') {
            let all = transacoes;
            if (db) {
                all = await db.transacoes.toArray();
            }

            const dateTag = new Date().toISOString().split('T')[0];
            if (format === 'csv') {
                const csv = createCSV(all);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `financeiro_${dateTag}.csv`;
                a.click(); URL.revokeObjectURL(url);
                return;
            }

            if (format === 'xml') {
                const xml = createXML(all);
                const blob = new Blob([xml], { type: 'application/xml;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `financeiro_${dateTag}.xml`;
                a.click(); URL.revokeObjectURL(url);
                return;
            }

            // default: json (inclui resumo)
            const dados = {
                transacoes: all,
                resumo: {
                    totalReceitas: all.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0),
                    totalDespesas: all.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0),
                    totalTransacoes: all.length
                }
            };

            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financeiro_${dateTag}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function sanitizeCSVField(value) {
            if (value === null || value === undefined) return '';
            const s = String(value);
            // escape double quotes
            if (s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')) {
                return '"' + s.replace(/"/g, '""') + '"';
            }
            return s;
        }

        function createCSV(items) {
            const headers = ['id','type','amount','category','description','date'];
            const rows = items.map(i => headers.map(h => sanitizeCSVField(i[h])).join(','));
            return headers.join(',') + '\n' + rows.join('\n');
        }

        function escapeForCdata(str) {
            // Garantir string e dividir ocorr√™ncias de ']]>' para n√£o quebrar CDATA
            return String(str || '').replace(/]]>/g, ']]]]><![CDATA[>');
        }

        function createXML(items, options = { includeId: false }) {
            // Gerar SpreadsheetML (XML compat√≠vel com Excel) para abrir como tabela
            // options.includeId: se true inclui coluna `id`; por padr√£o false para melhor legibilidade
            const header = `<?xml version="1.0" encoding="UTF-8"?>\n` +
                `<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" ` +
                `xmlns:o="urn:schemas-microsoft-com:office:office" ` +
                `xmlns:x="urn:schemas-microsoft-com:office:excel" ` +
                `xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n`;

                        // Estilos: cabe√ßalho em negrito, sombreamento de linhas, formatos de moeda/data, wrap e cores por tipo
                        // Estilos avan√ßados (fornecidos pelo usu√°rio)
                        const styles = `
    <Styles>
        <!-- T√≠tulo Principal -->
        <Style ss:ID="Title">
            <Font ss:Bold="1" ss:Size="18" ss:Color="#1e3a8a"/>
            <Alignment ss:Horizontal="Left" ss:Vertical="Center"/>
            <Interior ss:Color="#dbeafe" ss:Pattern="Solid"/>
            <Borders>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="2" ss:Color="#3b82f6"/>
            </Borders>
        </Style>
        
        <!-- Cabe√ßalho da Tabela -->
        <Style ss:ID="Header">
            <Font ss:Bold="1" ss:Size="11" ss:Color="#FFFFFF"/>
            <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
            <Interior ss:Color="#3b82f6" ss:Pattern="Solid"/>
            <Borders>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="2" ss:Color="#1e40af"/>
                <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#60a5fa"/>
                <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#60a5fa"/>
            </Borders>
        </Style>
        
        <!-- Tipo: Entrada (Verde) -->
        <Style ss:ID="Income">
            <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
            <Interior ss:Color="#22c55e" ss:Pattern="Solid"/>
            <Font ss:Color="#FFFFFF" ss:Bold="1" ss:Size="10"/>
            <Borders>
                <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
            </Borders>
        </Style>
        
        <!-- Tipo: Sa√≠da (Vermelho) -->
        <Style ss:ID="Expense">
            <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
            <Interior ss:Color="#ef4444" ss:Pattern="Solid"/>
            <Font ss:Color="#FFFFFF" ss:Bold="1" ss:Size="10"/>
            <Borders>
                <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
            </Borders>
        </Style>
        
        <!-- Moeda: Entrada -->
        <Style ss:ID="CurrencyPos">
            <Alignment ss:Horizontal="Right" ss:Vertical="Center"/>
            <NumberFormat ss:Format="_(&quot;R$&quot;\ * #,##0.00_);_(&quot;R$&quot;\ * \(#,##0.00\);_(&quot;R$&quot;\ * &quot;-&quot;??_);_(@_)"/>
            <Interior ss:Color="#dcfce7" ss:Pattern="Solid"/>
            <Font ss:Bold="1" ss:Color="#166534" ss:Size="10"/>
            <Borders>
                <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
            </Borders>
        </Style>
        
        <!-- Moeda: Sa√≠da -->
        <Style ss:ID="CurrencyNeg">
            <Alignment ss:Horizontal="Right" ss:Vertical="Center"/>
            <NumberFormat ss:Format="_(&quot;R$&quot;\ * #,##0.00_);_(&quot;R$&quot;\ * \(#,##0.00\);_(&quot;R$&quot;\ * &quot;-&quot;??_);_(@_)"/>
            <Interior ss:Color="#fee2e2" ss:Pattern="Solid"/>
            <Font ss:Bold="1" ss:Color="#991b1b" ss:Size="10"/>
            <Borders>
                <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
            </Borders>
        </Style>
        
        <!-- Categoria -->
        <Style ss:ID="Category">
            <Alignment ss:Horizontal="Left" ss:Vertical="Center"/>
            <Interior ss:Color="#f3f4f6" ss:Pattern="Solid"/>
            <Font ss:Size="10" ss:Color="#374151"/>
            <Borders>
                <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
            </Borders>
        </Style>
        
        <!-- Descri√ß√£o (com wrap) -->
        <Style ss:ID="Description">
            <Alignment ss:WrapText="1" ss:Vertical="Top" ss:Horizontal="Left"/>
            <Font ss:Size="9" ss:Color="#6b7280"/>
            <Interior ss:Color="#fafafa" ss:Pattern="Solid"/>
            <Borders>
                <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
            </Borders>
        </Style>
        
        <!-- Data -->
        <Style ss:ID="Date">
            <NumberFormat ss:Format="dd/mm/yyyy"/>
            <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
            <Font ss:Size="10" ss:Color="#374151"/>
            <Interior ss:Color="#f9fafb" ss:Pattern="Solid"/>
            <Borders>
                <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#e5e7eb"/>
            </Borders>
        </Style>
        
        <!-- Linha de Resumo/Total -->
        <Style ss:ID="SummaryLabel">
            <Font ss:Bold="1" ss:Size="11" ss:Color="#1f2937"/>
            <Alignment ss:Horizontal="Right" ss:Vertical="Center"/>
            <Interior ss:Color="#e5e7eb" ss:Pattern="Solid"/>
            <Borders>
                <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="2" ss:Color="#9ca3af"/>
            </Borders>
        </Style>
        
        <Style ss:ID="SummaryValue">
            <Font ss:Bold="1" ss:Size="11" ss:Color="#1f2937"/>
            <NumberFormat ss:Format="_(&quot;R$&quot;\ * #,##0.00_);_(&quot;R$&quot;\ * \(#,##0.00\);_(&quot;R$&quot;\ * &quot;-&quot;??_);_(@_)"/>
            <Alignment ss:Horizontal="Right" ss:Vertical="Center"/>
            <Interior ss:Color="#e5e7eb" ss:Pattern="Solid"/>
            <Borders>
                <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="2" ss:Color="#9ca3af"/>
            </Borders>
        </Style>
        
        <!-- Linha Alternada -->
        <Style ss:ID="EvenRow">
            <Interior ss:Color="#f8fafc" ss:Pattern="Solid"/>
        </Style>
    </Styles>\n`;

            // Colunas padr√£o (sem id para legibilidade)
            const cols = options.includeId ? ['id','type','amount','category','description','date'] : ['type','amount','category','description','date'];

            // definir larguras (aprox. pixels)
            const colWidths = options.includeId ? [110,100,80,120,260,90] : [100,80,120,260,90];

            let xml = header + styles;
            xml += `<Worksheet ss:Name="Transacoes">\n<Table>\n`;

            // Columns with widths
            colWidths.forEach(w => {
                xml += `  <Column ss:Width="${w}"/>\n`;
            });

            // header row (com estilo)
            xml += '  <Row>\n';
            cols.forEach(h => {
                // human-friendly labels
                const labelMap = { type: 'Tipo', amount: 'Valor', category: 'Categoria', description: 'Descri√ß√£o', date: 'Data', id: 'ID' };
                const label = labelMap[h] || h;
                xml += `    <Cell ss:StyleID="Header"><Data ss:Type="String">${escapeXml(label)}</Data></Cell>\n`;
            });
            xml += '  </Row>\n';

            // data rows (com formata√ß√£o, cores por tipo e linhas alternadas)
            items.forEach((i, rowIdx) => {
                const rowStyle = (rowIdx % 2 === 1) ? ' ss:StyleID="EvenRow"' : '';
                xml += `  <Row${rowStyle}>\n`;
                // iterar pelas colunas definidas em `cols` para manter ordem
                cols.forEach((colName, idx) => {
                    const raw = (i && i[colName] !== undefined && i[colName] !== null) ? i[colName] : '';
                    // identificar tipo da linha (se presente)
                    const rowType = i && i.type ? i.type : null;

                    // l√≥gica para cada coluna
                    if (colName === 'type') {
                        const display = (raw === 'income') ? 'ENTRADA' : (raw === 'expense') ? 'SA√çDA' : escapeXml(String(raw));
                        const styleId = (raw === 'income') ? 'Income' : (raw === 'expense') ? 'Expense' : null;
                        if (styleId) xml += `    <Cell ss:StyleID="${styleId}"><Data ss:Type="String">${escapeXml(display)}</Data></Cell>\n`;
                        else xml += `    <Cell><Data ss:Type="String">${escapeXml(display)}</Data></Cell>\n`;
                    } else if (colName === 'amount') {
                        if (raw !== '' && !isNaN(Number(raw))) {
                            const currencyStyle = (rowType === 'income') ? 'CurrencyPos' : 'CurrencyNeg';
                            xml += `    <Cell ss:StyleID="${currencyStyle}"><Data ss:Type="Number">${Number(raw)}</Data></Cell>\n`;
                        } else {
                            xml += `    <Cell><Data ss:Type="String">${escapeXml(String(raw))}</Data></Cell>\n`;
                        }
                    } else if (colName === 'date') {
                        let dateIso = '';
                        try {
                            const d = new Date(raw);
                            if (!isNaN(d.getTime())) dateIso = d.toISOString();
                        } catch (e) { dateIso = ''; }
                        if (dateIso) {
                            xml += `    <Cell ss:StyleID="Date"><Data ss:Type="DateTime">${dateIso}</Data></Cell>\n`;
                        } else {
                            xml += `    <Cell><Data ss:Type="String">${escapeXml(String(raw))}</Data></Cell>\n`;
                        }
                    } else if (colName === 'description') {
                        xml += `    <Cell ss:StyleID="Description"><Data ss:Type="String">${escapeXml(String(raw))}</Data></Cell>\n`;
                    } else {
                        // generic
                        xml += `    <Cell><Data ss:Type="String">${escapeXml(String(raw))}</Data></Cell>\n`;
                    }
                });
                xml += '  </Row>\n';
            });

            // Totais: Receitas, Despesas e Saldo
            const totalReceitas = items.filter(t => t.type === 'income').reduce((s, t) => s + (Number(t.amount) || 0), 0);
            const totalDespesas = items.filter(t => t.type === 'expense').reduce((s, t) => s + (Number(t.amount) || 0), 0);
            const saldo = totalReceitas - totalDespesas;
            const mergeAcross = Math.max(0, cols.length - 2);

            // Linha em branco espa√ßadora
            xml += '  <Row></Row>\n';

            // Total Receitas
            xml += '  <Row>\n';
            xml += `    <Cell ss:StyleID="SummaryLabel" ss:MergeAcross="${mergeAcross}"><Data ss:Type="String">Total Receitas</Data></Cell>\n`;
            xml += `    <Cell ss:StyleID="SummaryValue"><Data ss:Type="Number">${Number(totalReceitas)}</Data></Cell>\n`;
            xml += '  </Row>\n';

            // Total Despesas
            xml += '  <Row>\n';
            xml += `    <Cell ss:StyleID="SummaryLabel" ss:MergeAcross="${mergeAcross}"><Data ss:Type="String">Total Despesas</Data></Cell>\n`;
            xml += `    <Cell ss:StyleID="SummaryValue"><Data ss:Type="Number">${Number(totalDespesas)}</Data></Cell>\n`;
            xml += '  </Row>\n';

            // Saldo (usar cor positiva/negativa)
            xml += '  <Row>\n';
            xml += `    <Cell ss:StyleID="SummaryLabel" ss:MergeAcross="${mergeAcross}"><Data ss:Type="String">Saldo</Data></Cell>\n`;
            const saldoStyle = (saldo >= 0) ? 'CurrencyPos' : 'CurrencyNeg';
            xml += `    <Cell ss:StyleID="${saldoStyle}"><Data ss:Type="Number">${Number(saldo)}</Data></Cell>\n`;
            xml += '  </Row>\n';

            xml += `</Table>\n</Worksheet>\n</Workbook>`;
            return xml;
        }

        function escapeXml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe).replace(/[<>&\"']/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '"': return '&quot;';
                    case "'": return '&apos;';
                }
            });
        }

        // UI helper: pergunta ao usu√°rio qual formato deseja exportar
        function exportarDadosPrompt() {
            const choice = prompt('Escolha formato de exporta√ß√£o: csv, xml ou json', 'csv');
            if (!choice) return;
            const fmt = choice.trim().toLowerCase();
            if (!['csv','xml','json'].includes(fmt)) {
                alert('Formato inv√°lido. Use csv, xml ou json.');
                return;
            }
            exportarDados(fmt);
        }

        function toggleDarkMode() {
            const body = document.body;
            const isDarkMode = body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'true' : 'false');
            
            // Atualizar √≠cone do bot√£o tema
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.setAttribute('data-lucide', isDarkMode ? 'sun' : 'moon');
                lucide.createIcons();
            }
        }
        
        // Carregar prefer√™ncia de tema ao inicializar
        function loadDarkModePreference() {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode) {
                document.body.classList.add('dark-mode');
                const themeIcon = document.getElementById('theme-icon');
                if (themeIcon) {
                    themeIcon.setAttribute('data-lucide', 'sun');
                }
            }
        }

        function toggleChartView(tipo) {
            // Implementa√ß√£o para expandir gr√°fico - placeholder
            console.log('Expandir gr√°fico:', tipo);
        }

        function abrirModal() {
            document.getElementById('modal').classList.remove('hidden');
        }

        function fecharModal() {
            document.getElementById('modal').classList.add('hidden');
            limparFormulario();
        }

        function selecionarTipo(tipo) {
            tipoSelecionado = tipo;
            
            // Atualizar bot√µes
            document.getElementById('btn-income').className = tipo === 'income' 
                ? 'p-2 sm:p-4 rounded-lg sm:rounded-xl border-2 border-green-500 bg-green-50 transition-all flex items-center justify-center gap-2 text-xs sm:text-sm'
                : 'p-2 sm:p-4 rounded-lg sm:rounded-xl border-2 border-gray-300 hover:border-green-500 transition-all flex items-center justify-center gap-2 text-xs sm:text-sm';
            
            document.getElementById('btn-expense').className = tipo === 'expense' 
                ? 'p-2 sm:p-4 rounded-lg sm:rounded-xl border-2 border-red-500 bg-red-50 transition-all flex items-center justify-center gap-2 text-xs sm:text-sm'
                : 'p-2 sm:p-4 rounded-lg sm:rounded-xl border-2 border-gray-300 hover:border-red-500 transition-all flex items-center justify-center gap-2 text-xs sm:text-sm';
            
            atualizarCategorias();
        }

        function atualizarCategorias() {
            const select = document.getElementById('categoria');
            select.innerHTML = '<option value="">Selecione uma categoria</option>';
            
            categorias[tipoSelecionado].forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                select.appendChild(option);
            });
        }

        async function adicionarTransacao() {
            const valor = parseFloat(document.getElementById('valor').value);
            const categoria = document.getElementById('categoria').value;
            const descricao = document.getElementById('descricao').value;
            const data = document.getElementById('data').value;

            if (!valor || !categoria) {
                alert('Preencha o valor e a categoria');
                return;
            }

            const transacao = {
                id: Date.now(),
                type: tipoSelecionado,
                amount: valor,
                category: categoria,
                description: descricao,
                date: data
            };

            // salvar no DB (ou fallback localStorage)
            await saveTransacaoToDB(transacao);
            // atualizar array em mem√≥ria para UI imediata
            transacoes.unshift(transacao);

            atualizarDashboard();
            fecharModal();
        }

        async function removerTransacao(id) {
            await removeTransacaoFromDB(id);
            transacoes = transacoes.filter(t => t.id !== id);
            atualizarDashboard();
        }

        function limparFormulario() {
            document.getElementById('valor').value = '';
            document.getElementById('categoria').value = '';
            document.getElementById('descricao').value = '';
            document.getElementById('data').value = new Date().toISOString().split('T')[0];
            selecionarTipo('income');
        }

        // Name modal handlers
        function showNameModal() {
            document.getElementById('name-modal').classList.remove('hidden');
            const input = document.getElementById('username-input');
            if (input) input.focus();
        }

        function hideNameModal() {
            document.getElementById('name-modal').classList.add('hidden');
        }

        async function saveNameFromModal() {
            const input = document.getElementById('username-input');
            if (!input) return;
            const name = input.value && input.value.trim();
            if (!name) {
                alert('Digite um nome v√°lido');
                return;
            }
            await saveUsername(name);
            setGreeting(name);
            hideNameModal();
        }

        // Abre o modal de nome j√° preenchido para renomear
        async function renameUsername() {
            const current = await getSavedUsername();
            const input = document.getElementById('username-input');
            if (input) input.value = current || '';
            showNameModal();
            if (input) input.focus();
        }

        // Exclui todas as transa√ß√µes e o nome salvo (IndexedDB + localStorage)
        async function deleteAllData() {
            const ok = confirm('Confirma excluir TODOS os dados (transa√ß√µes e nome)? Esta a√ß√£o n√£o pode ser desfeita.');
            if (!ok) return;
            try {
                if (db) {
                    try { await db.transacoes.clear(); } catch(e){ console.warn('Erro limpando transacoes do DB', e); }
                    try { await db.app.clear(); } catch(e){ /* ignore if store missing */ }
                    try { await db.recorrentes.clear(); } catch(e){ /* ignore if store missing */ }
                }
                localStorage.removeItem('transacoes');
                localStorage.removeItem('username');
                localStorage.removeItem('transacoes_migrated');
                localStorage.removeItem('recorrentes');
            } catch (e) {
                console.error('Erro ao excluir dados', e);
            }
            transacoes = [];
            atualizarDashboard();
            alert('Dados exclu√≠dos com sucesso.');
        }

        function skipName() {
            hideNameModal();
        }

        function atualizarDashboard() {
            const receitas = transacoes.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const despesas = transacoes.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const despesasRecorrentes = (recorrentes || []).filter(r => r.active).reduce((s, r) => s + Number(r.amount || 0), 0);
            const despesasTotal = despesas + despesasRecorrentes;
            const saldo = receitas - despesas;

            // Atualizar cards principais
            document.getElementById('saldo-total').textContent = `R$ ${saldo.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('total-receitas').textContent = `R$ ${receitas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('total-despesas').textContent = `R$ ${despesasTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            
            // Contadores
            const qtdReceitas = transacoes.filter(t => t.type === 'income').length;
            const qtdDespesas = transacoes.filter(t => t.type === 'expense').length;
            document.getElementById('contador-receitas').textContent = `+${qtdReceitas}`;
            document.getElementById('contador-despesas').textContent = `${qtdDespesas}`;

            // Taxa de economia
            // considerar despesas recorrentes na taxa/proje√ß√µes
            const saldoConsiderandoRecorrentes = receitas - despesasTotal;
            const taxaEconomia = receitas > 0 ? ((saldoConsiderandoRecorrentes / receitas) * 100).toFixed(1) : 0;
            document.getElementById('taxa-economia').textContent = `Taxa de economia: ${taxaEconomia}%`;

            // Percentual de despesas
            const percentualDespesas = receitas > 0 ? ((despesasTotal / receitas) * 100).toFixed(1) : 0;
            document.getElementById('percentual-despesas').textContent = `${percentualDespesas}% da receita`;

            // Maior gasto
            const maioresGastos = transacoes.filter(t => t.type === 'expense').sort((a, b) => b.amount - a.amount);
            if (maioresGastos.length > 0) {
                const maiorGasto = maioresGastos[0];
                document.getElementById('maior-gasto').textContent = `R$ ${maiorGasto.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                document.getElementById('categoria-maior-gasto').textContent = maiorGasto.category;
            } else {
                document.getElementById('maior-gasto').textContent = 'R$ 0,00';
                document.getElementById('categoria-maior-gasto').textContent = 'Sem gastos';
            }

            // Atualizar m√©tricas r√°pidas
            atualizarMetricasRapidas();

            // Atualizar cor do saldo
            const saldoElement = document.getElementById('saldo-total');
            saldoElement.className = saldo >= 0 ? 'text-3xl font-bold text-gray-800' : 'text-3xl font-bold text-red-600';

            // Atualizar lista de transa√ß√µes
            atualizarListaTransacoes();
            
            // Atualizar gr√°ficos
            if (Object.keys(charts).length > 0) {
                criarGraficos();
            }
        }

        function atualizarMetricasRapidas() {
            const receitas = transacoes.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const despesas = transacoes.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const despesasRecorrentes = (recorrentes || []).filter(r => r.active).reduce((s, r) => s + Number(r.amount || 0), 0);
            const despesasTotal = despesas + despesasRecorrentes;
            const saldo = receitas - despesasTotal;

            // Meta de economia
            const metaEconomia = receitas > 0 ? Math.min(100, (saldo / receitas) * 100) : 0;
            document.getElementById('meta-economia').textContent = `${metaEconomia.toFixed(0)}%`;
            
            // Atualizar c√≠rculo de progresso
            const circunferencia = 2 * Math.PI * 18;
            const offset = circunferencia - (metaEconomia / 100) * circunferencia;
            document.getElementById('meta-progress').style.strokeDashoffset = offset;

            // Dias consecutivos sem gastos
            let diasConsecutivos = 0;
            const hoje = new Date();
            for (let i = 0; i < 30; i++) {
                const data = new Date(hoje);
                data.setDate(hoje.getDate() - i);
                const dataStr = data.toISOString().split('T')[0];
                
                const temGasto = transacoes.some(t => t.date === dataStr && t.type === 'expense');
                if (temGasto) break;
                diasConsecutivos++;
            }
            document.getElementById('dias-consecutivos').textContent = diasConsecutivos;

            // M√©dia di√°ria de gastos
            const diasComTransacao = new Set(transacoes.map(t => t.date)).size;
            const mediaDiaria = diasComTransacao > 0 ? despesasTotal / diasComTransacao : 0;
            document.getElementById('media-diaria').textContent = `R$ ${mediaDiaria.toLocaleString('pt-BR', { minimumFractionDigits: 0 })}`;

            // Proje√ß√£o do m√™s
            const diaAtual = new Date().getDate();
            const diasNoMes = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            // projecao inclui despesas recorrentes (assumindo que ocorrem este mes)
            const projecaoMes = ((despesasTotal) / diaAtual) * diasNoMes;
            document.getElementById('projecao-mes').textContent = `R$ ${projecaoMes.toLocaleString('pt-BR', { minimumFractionDigits: 0 })}`;

            // Atualizar barras de progresso das metas
            document.getElementById('meta-economia-percent').textContent = `${metaEconomia.toFixed(0)}%`;
            document.getElementById('progress-economia').style.width = `${metaEconomia}%`;

            const controleGastos = receitas > 0 ? Math.min(100, 100 - (despesas / receitas) * 100) : 100;
            document.getElementById('meta-gastos-percent').textContent = `${controleGastos.toFixed(0)}%`;
            document.getElementById('progress-gastos').style.width = `${controleGastos}%`;

            const categorias = new Set(transacoes.filter(t => t.type === 'expense').map(t => t.category));
            const diversificacao = Math.min(100, (categorias.size / 8) * 100);
            document.getElementById('meta-diversificacao-percent').textContent = `${diversificacao.toFixed(0)}%`;
            document.getElementById('progress-diversificacao').style.width = `${diversificacao}%`;
        }

        function atualizarListaTransacoes() {
            const container = document.getElementById('lista-transacoes');
            
            if (transacoes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 sm:py-12 px-2">
                        <p class="text-gray-500 text-base sm:text-lg">Nenhuma transa√ß√£o registrada</p>
                        <p class="text-gray-400 text-xs sm:text-sm mt-2">Adicione sua primeira transa√ß√£o</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = transacoes.slice(0, 10).map(transacao => `
                <div class="glass bg-white bg-opacity-20 rounded-xl sm:rounded-2xl p-3 sm:p-4 border border-white border-opacity-20 hover:bg-white hover:bg-opacity-25 transition-all duration-300 overflow-hidden">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-3">
                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                            <div class="p-2 rounded-lg flex-shrink-0 ${transacao.type === 'income' ? 'bg-green-400 bg-opacity-30' : 'bg-red-400 bg-opacity-30'}">
                                <i data-lucide="${transacao.type === 'income' ? 'trending-up' : 'trending-down'}" class="w-4 h-4 text-black"></i>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-1 mb-1 flex-wrap">
                                    <span class="text-lg">${getCategoryIcon(transacao.category)}</span>
                                    <p class="font-semibold text-black text-sm truncate">${transacao.category}</p>
                                </div>
                                <div class="flex items-center gap-1 flex-wrap">
                                    <p class="text-black text-opacity-60 text-xs truncate">${transacao.description || 'Sem descri√ß√£o'}</p>
                                    <span class="text-black text-opacity-40 text-xs">‚Ä¢</span>
                                    <p class="text-black text-opacity-50 text-xs whitespace-nowrap">
                                        ${new Date(transacao.date + 'T00:00:00').toLocaleDateString('pt-BR')}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <p class="text-sm sm:text-lg font-bold whitespace-nowrap relative ${transacao.type === 'income' ? 'text-green-600' : 'text-red-600'}" style="z-index:12;">
                                ${transacao.type === 'income' ? '+' : '-'} R$ ${transacao.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                            </p>
                            <button onclick="removerTransacao(${transacao.id})" class="p-1 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors flex-shrink-0">
                                <i data-lucide="trash-2" class="w-3 h-3 text-black text-opacity-60 hover:text-red-300"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Reinicializar √≠cones ap√≥s atualizar o DOM
            lucide.createIcons();
        }

        function getCategoryIcon(category) {
            const icons = {
                'Alimenta√ß√£o': 'üçΩÔ∏è',
                'Transporte': 'üöó',
                'Moradia': 'üè†',
                'Lazer': 'üéÆ',
                'Sa√∫de': 'üíä',
                'Educa√ß√£o': 'üìö',
                'Compras': 'üõçÔ∏è',
                'Contas': 'üìÑ',
                'Sal√°rio': 'üí∞',
                'Freelance': 'üíª',
                'Investimentos': 'üìà',
                'Outros': 'üì¶'
            };
            return icons[category] || 'üì¶';
        }

        // Fechar modal ao clicar fora
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModal();
            }
        });

        // ---------- Notifica√ß√µes de cobran√ßas recorrentes ----------
        const NOTIF_THRESHOLD_DAYS = 3; // ajustar conforme desejar

        function getNextDueDateForDay(day) {
            const hoje = new Date();
            const ano = hoje.getFullYear();
            let mes = hoje.getMonth(); // 0-indexed
            const candidato = new Date(ano, mes, day);
            if (candidato < new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate())) {
                // j√° passou esse m√™s -> pr√≥ximo m√™s
                mes = mes + 1;
            }
            // ajustar ano se necess√°rio
            let anoFinal = ano;
            if (mes > 11) { mes = 0; anoFinal = ano + 1; }
            // limitar dia entre 1 e 28 para evitar problemas com meses curtos
            const diaVal = Math.max(1, Math.min(28, day));
            return new Date(anoFinal, mes, diaVal);
        }

        function diffDays(a, b) {
            const _MS_PER_DAY = 1000 * 60 * 60 * 24;
            // floor difference in days
            const utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
            const utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
            return Math.floor((utc1 - utc2) / _MS_PER_DAY);
        }

        function _getDismissedMap() {
            try {
                return JSON.parse(localStorage.getItem('dismissed_rec_notifs') || '{}');
            } catch(e){ return {}; }
        }

        function _setDismissedMap(m) { localStorage.setItem('dismissed_rec_notifs', JSON.stringify(m)); }

        function markNotificationDismissed(recId, year, month) {
            const key = `${recId}-${year}-${month}`;
            const m = _getDismissedMap();
            m[key] = new Date().toISOString();
            _setDismissedMap(m);
        }

        async function markRecorrenteAsPaid(rec, dueDate) {
            // cria uma transa√ß√£o de despesa para registrar o pagamento
            const transacao = {
                id: Date.now(),
                type: 'expense',
                amount: Number(rec.amount),
                category: rec.category || 'Contas',
                description: `Pagamento: ${rec.name}`,
                date: dueDate.toISOString().split('T')[0]
            };
            await saveTransacaoToDB(transacao);
            transacoes.unshift(transacao);
            // marcar dismiss para essa ocorr√™ncia
            markNotificationDismissed(rec.id, dueDate.getFullYear(), dueDate.getMonth()+1);
            atualizarDashboard();
            renderRecorrentes();
            removeNotificationsUI();
        }

        function showSystemNotification(title, body) {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'granted') {
                new Notification(title, { body });
            }
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(p => console.log('Notification permission:', p));
            }
        }

        function removeNotificationsUI() {
            const area = document.getElementById('notifications-area');
            if (area) area.innerHTML = '';
        }

        function showInAppNotification(items) {
            const area = document.getElementById('notifications-area');
            if (!area) return;
            if (!items || items.length === 0) {
                // anima√ß√£o de sa√≠da r√°pida
                const existing = area.querySelector('.notif-card');
                if (existing) {
                    existing.classList.remove('notif-enter-active');
                    existing.classList.add('notif-exit-active');
                    setTimeout(() => area.innerHTML = '', 300);
                } else {
                    area.innerHTML = '';
                }
                return;
            }

            // montar conte√∫do interno
            const inner = document.createElement('div');
            inner.className = 'notif-card notif-enter';
            inner.style.background = 'linear-gradient(180deg,#ef4444,#dc2626)';
            inner.style.color = 'white';
            inner.innerHTML = `
                <div class="p-4">
                    <div style="display:flex;align-items:center;justify-content:space-between">
                        <div style="display:flex;align-items:center;gap:12px">
                            <div style="width:40px;height:40px;background:rgba(255,255,255,0.12);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700">‚ö†Ô∏è</div>
                            <div>
                                <div style="font-weight:700;font-size:16px">Cobran√ßas pr√≥ximas</div>
                                <div style="font-size:12px;opacity:0.95">Vencimentos em at√© ${NOTIF_THRESHOLD_DAYS} dias</div>
                            </div>
                        </div>
                        <div style="font-size:12px;opacity:0.95">${new Date().toLocaleDateString('pt-BR')}</div>
                    </div>
                    <div style="margin-top:12px;font-size:13px">
                        ${items.map(it => `
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;background:rgba(255,255,255,0.06);padding:8px;border-radius:8px">
                                <div>
                                    <div style="font-weight:600">${it.name}</div>
                                    <div style="font-size:12px;opacity:0.95">R$ ${Number(it.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})} ‚Ä¢ venc. ${it.dueDateLabel}</div>
                                </div>
                                <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
                                    <button id="pay-btn-${it.id}-${it.dueDate.getFullYear()}-${it.dueDate.getMonth()+1}" style="padding:6px 10px;font-size:12px;border-radius:8px;border:none;background:white;color:#b91c1c;font-weight:600">Pagar</button>
                                    <button id="dismiss-btn-${it.id}-${it.dueDate.getFullYear()}-${it.dueDate.getMonth()+1}" style="padding:6px 10px;font-size:12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.14);color:white">Ignorar</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top:10px;display:flex;justify-content:flex-end">
                        <button id="notif-open-rec-btn" style="padding:8px 12px;background:white;color:#dc2626;border-radius:8px;border:none;font-weight:600">Abrir gastos</button>
                    </div>
                </div>
            `;

            // limpar e colocar novo
            area.innerHTML = '';
            area.appendChild(inner);

            // for√ßar reflow e aplicar classe ativa para anima√ß√£o
            void inner.offsetWidth;
            inner.classList.add('notif-enter-active');

            // associar handlers
            items.forEach(it => {
                const payId = `pay-btn-${it.id}-${it.dueDate.getFullYear()}-${it.dueDate.getMonth()+1}`;
                const dismissId = `dismiss-btn-${it.id}-${it.dueDate.getFullYear()}-${it.dueDate.getMonth()+1}`;
                const payBtn = document.getElementById(payId);
                const dismissBtn = document.getElementById(dismissId);
                if (payBtn) {
                    payBtn.addEventListener('click', async () => {
                        // anima√ß√£o de sa√≠da
                        inner.classList.remove('notif-enter-active');
                        inner.classList.add('notif-exit-active');
                        setTimeout(async () => {
                            await markRecorrenteAsPaid(it, it.dueDate);
                            await checkUpcomingRecorrentes();
                        }, 260);
                    });
                }
                if (dismissBtn) {
                    dismissBtn.addEventListener('click', () => {
                        markNotificationDismissed(it.id, it.dueDate.getFullYear(), it.dueDate.getMonth()+1);
                        inner.classList.remove('notif-enter-active');
                        inner.classList.add('notif-exit-active');
                        setTimeout(() => checkUpcomingRecorrentes(), 260);
                    });
                }
            });

            const openBtn = document.getElementById('notif-open-rec-btn');
            if (openBtn) openBtn.addEventListener('click', () => { closeRecorrenteModal(); openRecorrenteModal(); });
        }

        async function checkUpcomingRecorrentes() {
            if (!recorrentes || recorrentes.length === 0) return removeNotificationsUI();
            const hoje = new Date();
            const m = _getDismissedMap();
            const pr√≥ximos = [];
            for (const r of recorrentes.filter(r=>r.active)) {
                const due = getNextDueDateForDay(r.day || 1);
                const daysUntil = diffDays(due, hoje);
                const key = `${r.id}-${due.getFullYear()}-${due.getMonth()+1}`;
                if (daysUntil >= 0 && daysUntil <= NOTIF_THRESHOLD_DAYS && !m[key]) {
                    pr√≥ximos.push({ ...r, dueDate: due, daysUntil, dueDateLabel: due.toLocaleDateString('pt-BR') });
                }
            }
            if (pr√≥ximos.length > 0) {
                // notifica√ß√£o in-app
                showInAppNotification(pr√≥ximos);
                // notifica√ß√£o do sistema (concisa)
                try {
                    requestNotificationPermission();
                    primeiros = pr√≥ximos.slice(0,3).map(p => `${p.name} R$ ${Number(p.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`).join(' ‚Ä¢ ');
                    showSystemNotification('Cobran√ßas pr√≥ximas', primeiros);
                } catch(e){console.warn(e)}
            } else {
                removeNotificationsUI();
            }
        }

        // rodar checagem ap√≥s carregar recorrentes e a cada hora
        (function scheduleRecorrentesChecks(){
            try { requestNotificationPermission(); } catch(e){}
            // checar logo ap√≥s iniciar (algumas vezes recorrentes j√° carregadas)
            setTimeout(checkUpcomingRecorrentes, 1000);
            // checar sempre que houver mudan√ßas relevantes (atualizar tamb√©m ao salvar/remover)
            setInterval(checkUpcomingRecorrentes, 1000 * 60 * 60); // cada 1h
        })();

        // --- Menu visual para exportar ---
        let __exportMenuEl = null;
        function showExportMenu(e) {
            e.stopPropagation();
            const btn = document.getElementById('export-btn');
            if (!btn) return;
            // se j√° existe, remover
            if (__exportMenuEl) { __exportMenuEl.remove(); __exportMenuEl = null; return; }

            const menu = document.createElement('div');
            menu.className = 'export-menu';

            const optCsv = document.createElement('div'); optCsv.className = 'export-option export-csv';
            optCsv.innerHTML = '<div class="dot"></div><div><strong>CSV</strong><div style="font-size:12px;color:#6b7280">Planilha (separado por v√≠rgula)</div></div>';
            optCsv.addEventListener('click', () => { exportarDados('csv'); closeExportMenu(); });

            const optXml = document.createElement('div'); optXml.className = 'export-option export-xml';
            optXml.innerHTML = '<div class="dot"></div><div><strong>XML</strong><div style="font-size:12px;color:#6b7280">Dados em formato XML</div></div>';
            optXml.addEventListener('click', () => { exportarDados('xml'); closeExportMenu(); });

            const optJson = document.createElement('div'); optJson.className = 'export-option export-json';
            optJson.innerHTML = '<div class="dot"></div><div><strong>JSON</strong><div style="font-size:12px;color:#6b7280">Arquivo JSON (resumo incluso)</div></div>';
            optJson.addEventListener('click', () => { exportarDados('json'); closeExportMenu(); });

            menu.appendChild(optCsv);
            menu.appendChild(optXml);
            menu.appendChild(optJson);

            document.body.appendChild(menu);
            __exportMenuEl = menu;

            // posicionar pr√≥ximo ao bot√£o
            const rect = btn.getBoundingClientRect();
            const top = rect.bottom + 8 + window.scrollY;
            const right = window.innerWidth - rect.right + 8;
            menu.style.top = `${top}px`;
            menu.style.left = `${rect.right - menu.offsetWidth}px`;
            // ajustar se ultrapassar a viewport
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.right > window.innerWidth - 8) {
                menu.style.left = `${window.innerWidth - menuRect.width - 8}px`;
            }

            // fechar ao clicar fora
            setTimeout(() => {
                document.addEventListener('click', __closeExportOnOutside);
            }, 0);
        }

        function __closeExportOnOutside(ev) {
            if (!__exportMenuEl) return;
            if (!__exportMenuEl.contains(ev.target) && ev.target.id !== 'export-btn') {
                closeExportMenu();
            }
        }

        function closeExportMenu() {
            if (__exportMenuEl) { __exportMenuEl.remove(); __exportMenuEl = null; }
            document.removeEventListener('click', __closeExportOnOutside);
        }
    </script>
</script>

    <!-- Rodap√© -->
    <footer class="w-full mt-6 sm:mt-8 py-2 sm:py-4 bg-transparent text-center px-2">
        <p class="text-xs text-gray-700">MGV Group ‚Äî Todos os direitos reservados, 2025</p>
    </footer>
</body>
</html>
